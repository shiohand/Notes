# セキュリティ対策

- [クロスサイトスクリプティング](#クロスサイトスクリプティング)
- [SQLインジェクション](#sqlインジェクション)
- [OSコマンドインジェクション](#osコマンドインジェクション)
- [クロスサイトリクエストフォージェリ](#クロスサイトリクエストフォージェリ)
- [パストラバーサル](#パストラバーサル)
- [メールヘッダインジェクション](#メールヘッダインジェクション)
- [HTTPレスポンス分割攻撃](#httpレスポンス分割攻撃)
- [セッションハイジャック](#セッションハイジャック)
- [ファイルアップロード攻撃](#ファイルアップロード攻撃)
- [インクルード攻撃](#インクルード攻撃)
- [入力値の検証](#入力値の検証)

## クロスサイトスクリプティング
エスケープ処理
ライブラリの利用(HTML Purifierなど)

## SQLインジェクション
PDOとプレースホルダ

## OSコマンドインジェクション
エスケープ処理(escapeshellarg() escapeshellcmd())
そもそも外部入力からコマンド作るな

## クロスサイトリクエストフォージェリ
action=""によそのサイトを指定してフォームを勝手に送信する的なやつ
ワンタイムトークン トークンを隠しフィールドに埋め込み、データ処理側で照合する

フォーム

```php
$token = sha1(uniqid(mt_rand(), true));
$_SESSION['token'] = $token;
input type="hidden" value="トークン出力"
```
データ処理
```php
if (!isset($_post['token']) || $_POST['token'] !== $_SESSION['token']) {
  die('不正なアクセスが行われました');
}
```

## パストラバーサル
ファイルのパスを直接受け渡ししない
ホワイトリストを利用

```php
$fl = $_GET['path'];

$flag = false; // ホワイトリスト
$dir = new DirectoryIterator('./doc/');
foreach ($dir as $file) {
  if ($file->isFile() && $file->getFileName() === $fl) { // 一致確認
    $fl = $file->getFileName(); // 確実に置き換え。nullバイト攻撃にも対応？
    $flag = true;
    break;
  }
}
if (!$flag) {
  die('不正な要求です。');
}
```

## メールヘッダインジェクション
メールアドレスの検証

```php
if (!preg_match('/^\w([-+.\']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/i', $_POST['form'])) {
die('不正なメールアドレスです。');
}
mb_send_mail('wings@example.com', $_POST['subject'], $_POST['body'], "From: {$_POST['from']}");
```

## HTTPレスポンス分割攻撃
ヘッダー情報の入力に改行を入れて不正なヘッダを混入させる
改行文字(\n, \r)の除去

## セッションハイジャック
適当なタイミングでセッションを再生成させる
session_regenerate_id関数
## ファイルアップロード攻撃
アップロード先を非公開フォルダに設定し、最悪の場合でも実行されてしまわないようにする
## インクルード攻撃
インクルード命令に関わるクエリに不正なパスを渡す
arrow_url_includeパラメータをOff
ホワイトリスト
そもそもインクルード命令をクエリから取らない

## 入力値の検証
→MyValidator.php