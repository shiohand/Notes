# 正規表現

- [正規表現基礎](#正規表現基礎)
  - [正規表現の全体](#正規表現の全体)
- [メタ文字](#メタ文字)
- [パターンマッチ](#パターンマッチ)
  - [preg_match()](#preg_match)
  - [preg_match_all()](#preg_match_all)
- [文字列置換](#文字列置換)
  - [preg_replace()](#preg_replace)
    - [マッチ文字列を置換後文字列に含める(プレースホルダ的に)](#マッチ文字列を置換後文字列に含めるプレースホルダ的に)
  - [preg_replace_callback()](#preg_replace_callback)
- [文字列分割](#文字列分割)
  - [preg_split()](#preg_split)

## 正規表現基礎

正規表現の種類 -> Perl互換正規表現(PCRE)

### 正規表現の全体
* /正規表現パターン/修飾子
* //などで囲んだ中に正規表現パターン。右側に修飾子

## メタ文字

(繰り返し、とは、ひとつ前の文字,メタ文字)
(0回, 1回とは、対象の文字を含めて。a*ならaはなくてもよい)

| 基本        | -                          |
| ----------- | -------------------------- |
| .           | 任意の一文字(改行をのぞく) |
| \*          | 0回 以上繰り返し           |
| \+          | 1回 以上繰り返し           |
| ?           | 0回 または 1回 の繰り返し  |
| .? *? +? ?? | 最短一致                   |
| ^           | 先頭                       |
| $           | 末尾                       |
|             | 選択                       |

| 正規表現のグループ | -                            |
| ------------------ | ---------------------------- |
| ()                 | 正規表現のグループ           |
| (ab)+              | abの1回以上繰り返し ababなど |

| 文字クラス  | -                         |
| ----------- | ------------------------- |
| []          | 文字クラス                |
| [文字]      | (文 or 字)                |
| [0-9]       | (0 ~ 9)                   |
| [a-]        | (a ~)     かな？          |
| [a-zA-Z0-9] | (a ~ z or A ~ Z or 0 ~ 9) |

| 文字クラスNOT | -             |
| ------------- | ------------- |
| [^]           | 文字クラスNOT |
| [^文字]       | not(文 or 字) |

| 繰り返し | -                           |
| -------- | --------------------------- |
| {n}      | n回 の繰り返し              |
| {n,}     | n回 以上の繰り返し          |
| {n,m}    | n回 以上 m回 以下の繰り返し |

| 他    | -                                                                           |
| ----- | --------------------------------------------------------------------------- |
| \     | エスケープ                                                                  |
| /     | パターンの最初と最後に指定 正規表現を囲う                                   |
| -     | 正規表現パターンに`/`を含む場合はエスケープするか`\|`などを使う |
| `//i` | 正規表現の大文字と小文字を区別しない                                        |
| `//m` | 改行の前後も先頭・末尾として扱う                                            |
| `//e` | 置換後文字列をPHPのコードとして処理(非推奨・削除) → preg_replace_callback() |
| `//u` | 正規表現パターンをUTF-8文字列として扱う(バイナリ以外は必須)                 |

| 文字セット | -                     |
| ---------- | --------------------- |
| `\t`       | タブ                  |
| `\n`       | 改行                  |
| `\r`       | 復帰                  |
| `\d`       | 数値([0-9])           |
| `\D`       | ^数値                 |
| `\s`       | 空白([ \t\n\f\r])     |
| `\S`       | ^数値                 |
| `\w`       | 半角英数([a-zA-Z0-9]) |
| `\W`       | ^半角英数             |

## パターンマッチ

### preg_match()
* `preg_match(正規表現, 対象文字列[, &格納用配列[, オプション[, オフセット]]])`
* 対象文字列から最初に正規表現にマッチした部分を配列に格納する
* 正規表現にパターンのグループが含まれている場合、部分マッチしたところが配列の二番目以降に格納される。
* オプション PREG_OFFSET_CAPTURE で、マッチ部分のオフセットを取得(配列は入れ子に)

```php
$str = "Let's PHP!";
preg_match("/[A-Z]{3}/", $str, $s); // 0 => "PHP"
preg_match("/^[a-z]/i", $str, $s); // 0 => "L"
$str = "I love cat and dog.";
preg_match("/love (.+) and (.+)\./", $str, $r);
// 0 => "love cat and dog.", 1 => "cat", 2 => "dog"
```
```php
$str = "彼の電話番号は0399-88-9785、私のは0398-99-1234です。郵便番号はどちらも687-1109です。";
if (preg_match("/([0-9]{2,4})-([0-9]{2,4})-([0-9]{4})/", $str, $data)) {
  print "電話番号 : {$data[0]} <br>";  // 0399-88-9785
  print "市外局番 : {$data[1]} <br>";  // 0399
  print "市内局番 : {$data[2]} <br>";  // 88
  print "加入者番号 : {$data[3]} <br>"; // 9785
}
if (preg_match("/([0-9]{2,4})-([0-9]{2,4})-([0-9]{4})/", $str, $data, PREG_OFFSET_CAPTURE)) {
  print "電話番号 : {$data[0][1]} <br>";  // 21
  print "市外局番 : {$data[1][1]} <br>";  // 21
  print "市内局番 : {$data[2][1]} <br>";  // 26
  print "加入者番号 : {$data[3][1]} <br>"; // 29
}
```

### preg_match_all()
* `preg_match_all(正規表現, 対象文字列[, &格納用配列[, オプション[, オフセット]]])`
* マッチする全ての部分を格納
* オプション(独習p188)

`PREG_SET_ORDER` で `[[マッチ1, サブマッチ1], [マッチ2, サブマッチ2], ...]`
`PREG_PATTERN_ORDER` で `[[マッチ1, マッチ２], [サブマッチ1, サブマッチ2], ...]`

```php
if (preg_match_all("/([0-9]{2,4})-([0-9]{2,4})-([0-9]{4})/", $str, $data, PREG_OFFSET_CAPTURE | PREG_SET_ORDER)) {
  foreach ($data as $item) {
    print "電話番号 : {$item[0][1]} <br>";  // 1周目 21
    print "市外局番 : {$item[1][1]} <br>";  // 1周目 21
    print "市内局番 : {$item[2][1]} <br>";  // 1周目 26
    print "加入者番号 : {$item[3][1]} <br>"; // 1周目 29
  }
}
```

## 文字列置換

### preg_replace()
* `preg_replace(正規表現, 置換後文字列, 対象文字列[, 上限回数 = -1[, &置換数格納用変数]])`
* 置換が行われなかった場合も変換前の文字列のまま戻ってくる

```php
$str = "There is no pen. I want a pencil.";
$str2 = preg_replace("/pen(cil)?/", "pencil", $str);
```

#### マッチ文字列を置換後文字列に含める(プレースホルダ的に)

`$0`にそれぞれのマッチ文字列(今回はURL)が入る `$1`, `$2`...とサブマッチ文字列
後続の文字列と混ざる場合は`${0}`などする

```php
$msg = <<<EOD
サンプルは、「サーバーサイド義j痛の学び舎(http://www.wings.msn.to/)」から入手できます。執筆のノウハウ集「WINGS Knowledge」(http://www31.atwiki.jp/wingsproject)もどうぞ。
EOD;
print preg_replace('|http(s)?://([\w-]+\.)+[\w-]+(/[\w- ./?%&=]*)?|', '<a href="&0">&0</a>', $msg);
```

### preg_replace_callback()

* `preg_replace_callback(正規表現, 置換後文字列を作成する関数, 対象文字列[, 上限回数 = -1[, &置換数格納用変数]])`
* クロージャ(引数はマッチ文字列の配列が入る)でマッチ文字列を加工して置換する

```php
print preg_replace_callback(
  '|http(s)?://([\w-]+\.)+[\w-]+(/[\w- ./?%&=]*)?|i',
  function($matches) {
    foreach($matches as $match) {
      return mb_strtoupper($match);
    }
  },
  $msg
); // URL部分が大文字になる
```

## 文字列分割

### preg_split()

* `preg_split(正規表現による区切り文字, 対象文字列[, 上限回数 = -1[, オプション]])`

| オプション(`\|`で組み合わせ可能) | -                                      |
| -------------------------------- | -------------------------------------- |
| PREG_SPLIT_NO_EMPTY              | 空文字列となった要素は除去する         |
| PREG_SPLIT_DELIM_CAPTURE         | 区切り文字のサブマッチ文字列部分を残す |
| PREG_SPLIT_OFFSET_CAPTURE        | オフセット値を返す                     |

```php
$str = "2006 12/25";
list($year, $month, $day) = preg_split("/[ \\]/", $str); // リストで受け取るのもよい
// 0 => 2006, 1 => 12, 2 => 25
// [ \\] は ' '半角スペース or \バックスラッシュ
```
```php
$today = '2016-05-14';
$result = preg_split('|([/.\-]|', $today, -1, PREG_SPLIT_DELIM_CAPTURE);
// [2016, -, 05, -, 14]
```

